# 🎮 完整 P2P 交易测试指南

## 📝 测试场景

测试两个用户之间的完整 P2P NFT 交易流程。

---

## 🚀 前提准备

### 1. 启动 Hardhat 节点
```bash
npx hardhat node
```
保持此终端运行。

### 2. 部署智能合约
```bash
npx hardhat run scripts/deploy.ts --network localhost
```

### 3. 启动游戏
```bash
python main.py
```

---

## 👥 测试用户

| 用户 | 钱包地址 | 说明 |
|------|----------|------|
| **Inaglyite** | `0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266` | Hardhat 账户 #0 |
| **huangjin** | `0x70997970C51812dc3A010C7d01b50e0d17dc79C8` | Hardhat 账户 #1 |

---

## 📋 完整测试流程

### 阶段 1: 用户 A 发起交易

#### 1.1 登录用户 A
- 启动游戏
- 点击"登录"
- 输入用户名：`Inaglyite`
- 输入密码：`123`
- 点击"登录"

**预期日志：**
```
✅ 登录成功！
🔗 切换到用户钱包: 0xf39Fd6e5...
🔄 正在加载游戏数据...
加载了 2 把武器，其中 0 把已上架
✅ 游戏数据加载完成
```

#### 1.2 添加好友（如果还没有）
- 点击"个人中心"
- 选择"好友"标签
- 点击"添加好友"
- 输入好友名：`huangjin`
- 点击"添加"

#### 1.3 发起交易
- 在"好友"列表中选择 `huangjin`
- 点击"交易"按钮
- 选择一个武器（例如 Sharp Sickle）
- 点击"查看详情"

**应该看到：**
```
╔════════════════════════════════════╗
║       武器详情                     ║
╠════════════════════════════════════╣
║  [武器贴图]                        ║
║  Sharp Sickle                      ║
║  稀有度: RARE                      ║
║  伤害倍率: 1.2x                    ║
║  磨损度: 1.27%                     ║
╠════════════════════════════════════╣
║  [发起报价]  [返回]                ║
╚════════════════════════════════════╝
```

#### 1.4 输入价格
- 点击"发起报价"
- 输入价格：`0.0001`（ETH）
- 按回车确认

**预期日志：**
```
💾 武器 2 已保存到本地存储
🔗 在区块链上创建交易报价...
⏳ 创建交易报价: [tx_hash] 等待确认...
✅ 交易报价已创建，报价ID: 3
✅ 区块链交易报价已创建
✅ 已向 huangjin 发送交易请求
✅ 交易报价已发送（区块链 + 本地）
```

---

### 阶段 2: 用户 B 查看和接受交易

#### 2.1 退出用户 A
- 按 ESC 返回菜单
- 点击"退出登录"

#### 2.2 登录用户 B
- 点击"登录"
- 输入用户名：`huangjin`
- 输入密码：`123`
- 点击"登录"

**预期日志：**
```
✅ 登录成功！
🔗 切换到用户钱包: 0x70997970...  ← 注意这里是不同的地址！
🔄 正在加载游戏数据...
加载了 1 把武器，其中 0 把已上架
✅ 游戏数据加载完成
```

#### 2.3 查看交易请求
- 点击"个人中心"
- 选择"好友"标签
- 选择"交易请求"标签

**应该看到：**
```
交易请求 (1)
────────────────────────────
来自: Inaglyite
武器: Sharp Sickle
价格: 0.0001 ETH
[查看详情]
```

#### 2.4 查看交易详情
- 点击"查看详情"

**应该看到（修复后）：**
```
╔════════════════════════════════════╗
║     📋 交易请求详情                ║
╠════════════════════════════════════╣
║  来自: Inaglyite                   ║
║                                    ║
║  [武器贴图 - Sharp Sickle]         ║
║                                    ║
║  Sharp Sickle                      ║
║  稀有度: RARE                      ║
║  伤害倍率: 1.2x                    ║
║  磨损度: 1.27%                     ║
║                                    ║
║  💰 0.0001 ETH                     ║
╠════════════════════════════════════╣
║  [接受]           [拒绝]           ║
╚════════════════════════════════════╝
```

**预期日志：**
```
📋 查看交易请求详情: [trade_id]...
✅ 从区块链加载武器信息: Sharp Sickle (ID: 2)  ← 关键！
```

#### 2.5 接受交易
- 点击"接受"按钮

**预期日志：**
```
🔗 执行区块链 P2P 交易...
   武器 ID: 2
   从: 0xf39Fd6e5...
   到: 0x70997970...  ← 注意地址不同
   价格: 0.0001 ETH
🔍 找到 1 个收到的报价
✅ 找到链上报价 ID: 3
⏳ 交易哈希: [tx_hash] 等待确认...
✅ 区块链交易成功！
   ✓ NFT 武器 #2 已转移到 0x70997970...
   ✓ 0.0001 ETH 已支付给 0xf39Fd6e5...
✅ 交易请求已接受，NFT 所有权已在区块链上转移
🔄 正在加载游戏数据...
加载了 2 把武器，其中 0 把已上架  ← 武器数量增加！
🎉 好友交易完成！
   武器所有权已在区块链上永久记录
```

#### 2.6 验证武器到账
- 按 I 打开背包
- 应该看到 Sharp Sickle 在你的背包中

---

### 阶段 3: 验证交易结果

#### 3.1 切换回用户 A
- 退出登录
- 登录 Inaglyite
- 打开背包

**预期结果：**
- ✅ Sharp Sickle 不再在背包中
- ✅ 武器数量减少 1

#### 3.2 查看区块链数据
运行测试脚本：
```bash
python test_p2p_trade.py
```

**预期输出：**
```
账户 1 武器数量: 3 → 2
账户 2 武器数量: 0 → 1
✅ 所有权验证成功！武器已转移到账户 2
```

#### 3.3 查看钱包余额
```python
from src.blockchain import BlockchainManager
from web3 import Web3

bm1 = BlockchainManager(account_index=0)
bm1.setup()

bm2 = BlockchainManager(account_index=1)
bm2.setup()

balance1 = bm1.w3.eth.get_balance(bm1.account)
balance2 = bm2.w3.eth.get_balance(bm2.account)

print(f"账户 1: {Web3.from_wei(balance1, 'ether')} ETH")
print(f"账户 2: {Web3.from_wei(balance2, 'ether')} ETH")
```

**预期结果：**
```
账户 1: 10000.0001... ETH  ← 增加了 0.0001 ETH
账户 2: 9999.9999... ETH   ← 减少了 0.0001 ETH (+ gas)
```

---

## ✅ 成功标志

如果你看到以下内容，说明系统完全正常：

### 1. 武器信息显示
- ✅ 交易请求详情页面显示完整武器信息
- ✅ 显示武器贴图
- ✅ 显示稀有度、伤害、磨损度
- ✅ 日志显示"从区块链加载武器信息"

### 2. 交易执行
- ✅ 链上创建报价成功
- ✅ 接收者能查询到报价
- ✅ 接受报价后 NFT 转移
- ✅ ETH 支付成功

### 3. 数据一致性
- ✅ 发送者武器数量减少
- ✅ 接收者武器数量增加
- ✅ 区块链上所有权正确
- ✅ 钱包余额正确变化

---

## ❌ 常见问题排查

### 问题 1: 显示"武器信息不可用"

**症状：**
```
❌ 武器信息不可用
```

**原因：** 旧代码未修复

**解决：**
```bash
# 确认代码已更新
grep -A 5 "从区块链直接查询" src/trade_ui.py
```

应该看到新的区块链查询代码。

---

### 问题 2: "未找到对应的链上报价"

**症状：**
```
🔍 找到 0 个收到的报价
❌ 未找到对应的链上报价
```

**原因：** 钱包地址未正确更新

**检查：**
```python
# 查看日志中的地址
从: 0xf39Fd6e5...
到: 0xf39Fd6e5...  ← 如果相同就是问题！
```

**解决：**
- 确保登录时看到"🔗 切换到用户钱包"
- 两个用户的钱包地址应该不同

---

### 问题 3: 区块链查询失败

**症状：**
```
⚠️ 从区块链查询武器 X 失败: ...
```

**检查：**
1. Hardhat 节点是否运行
2. 合约是否部署
3. 武器 ID 是否存在

**测试：**
```bash
python -c "
from src.blockchain import BlockchainManager
bm = BlockchainManager()
bm.setup()
weapon = bm.contract.functions.getWeaponDetails(2).call()
print(weapon)
"
```

---

## 🎯 测试清单

完整测试前请确认：

- [ ] Hardhat 节点运行中
- [ ] 智能合约已部署
- [ ] 两个测试账户已注册
- [ ] 两个账户互为好友
- [ ] 发起者拥有至少一个武器
- [ ] 代码已更新（包含区块链查询）

---

## 📊 预期数据流

```
用户 A 发起交易
  ↓
创建链上报价 (createTradeOffer)
  ↓
智能合约记录报价
  ↓
用户 B 登录
  ↓
查看交易请求
  ↓
调用 getWeaponDetails(weaponId) ← 从区块链查询
  ↓
显示完整武器信息 ✅
  ↓
用户 B 接受报价
  ↓
调用 acceptTradeOffer(offerId)
  ↓
智能合约转移 NFT
  ↓
触发 Transfer 事件
  ↓
所有权永久记录在区块链 ✅
```

---

## 🎉 总结

完整的 P2P 交易系统现在完全正常工作：

1. ✅ 发起交易 - 创建链上报价
2. ✅ 查看交易 - 显示完整武器信息（从区块链查询）
3. ✅ 接受交易 - NFT 转移 + ETH 支付
4. ✅ 验证结果 - 所有权正确、余额正确

**这是一个真正的去中心化 NFT 交易系统！**

所有数据存储在区块链上，任何人都可以验证交易的真实性和武器的所有权。

