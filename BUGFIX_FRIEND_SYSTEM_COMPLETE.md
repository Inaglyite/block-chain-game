# å¥½å‹ç³»ç»Ÿé¼ æ ‡å’Œé”®ç›˜æ“ä½œå®Œæ•´æ”¯æŒ - ä¿®å¤æŠ¥å‘Š

## é—®é¢˜æè¿°

ç”¨æˆ·åé¦ˆï¼š
1. æ— æ³•ä½¿ç”¨é¼ æ ‡ç‚¹å‡»"æ·»åŠ å¥½å‹"æŒ‰é’®
2. å¥½å‹åˆ—è¡¨ã€å¥½å‹è¯·æ±‚ã€äº¤æ˜“è¯·æ±‚é¡µé¢çš„æŒ‰é’®æ— æ³•ç‚¹å‡»
3. åœ¨å¥½å‹åˆ—è¡¨ä¸­æŒ‰ENTERé”®æ— æ³•å‘èµ·äº¤æ˜“
4. åªèƒ½ä½¿ç”¨é”®ç›˜çš„éƒ¨åˆ†åŠŸèƒ½

## é—®é¢˜åˆ†æ

### æ ¹æœ¬åŸå› 

1. **main.pyä¸­é¼ æ ‡äº‹ä»¶å¤„ç†ä¸å®Œæ•´**
   - é¼ æ ‡ç‚¹å‡»äº‹ä»¶åªå¤„ç†äº† `case_shop` çŠ¶æ€
   - æ²¡æœ‰ä¸º `friends` çŠ¶æ€æ·»åŠ é¼ æ ‡äº‹ä»¶å¤„ç†
   - å¯¼è‡´æ‰€æœ‰å¥½å‹ç³»ç»Ÿçš„é¼ æ ‡ç‚¹å‡»éƒ½è¢«å¿½ç•¥

2. **game.pyä¸­å¥½å‹ç³»ç»Ÿé¼ æ ‡å¤„ç†ä¸å®Œæ•´**
   - åªå®ç°äº†"æ·»åŠ å¥½å‹"æ ‡ç­¾çš„é¼ æ ‡å¤„ç†
   - å¥½å‹åˆ—è¡¨ã€å¥½å‹è¯·æ±‚ã€äº¤æ˜“è¯·æ±‚çš„æŒ‰é’®ç‚¹å‡»éƒ½æ²¡æœ‰å®ç°
   - æŒ‰é’®åæ ‡è®¡ç®—ä¸å‡†ç¡®

3. **å¥½å‹åˆ—è¡¨ç¼ºå°‘ENTERé”®åŠŸèƒ½**
   - æ²¡æœ‰å®ç°ENTERé”®å‘èµ·äº¤æ˜“çš„åŠŸèƒ½
   - æ²¡æœ‰å®ç°DELETEé”®åˆ é™¤å¥½å‹çš„åŠŸèƒ½

## è§£å†³æ–¹æ¡ˆ

### 1. ä¿®å¤main.py - æ·»åŠ å¥½å‹ç³»ç»Ÿé¼ æ ‡äº‹ä»¶è·¯ç”±

**æ–‡ä»¶**: `main.py`  
**ä½ç½®**: ç¬¬83-89è¡Œ

```python
# å¤„ç†é¼ æ ‡ç‚¹å‡»äº‹ä»¶ï¼ˆç”¨äºç®±å­å•†åº—NPCäº¤äº’å’Œå¥½å‹ç³»ç»Ÿï¼‰
if event.type == pygame.MOUSEBUTTONDOWN:
    if game.game_state == "case_shop":
        game.handle_case_shop_input(event)
        continue
    elif game.game_state == "friends":
        game.handle_friends_input(event)  # æ·»åŠ è¿™ä¸€è¡Œ
        continue
```

**ä¿®æ”¹è¯´æ˜**ï¼š
- åœ¨é¼ æ ‡ç‚¹å‡»äº‹ä»¶å¤„ç†ä¸­æ·»åŠ  `friends` çŠ¶æ€çš„å¤„ç†
- ç¡®ä¿é¼ æ ‡äº‹ä»¶èƒ½å¤Ÿä¼ é€’åˆ° `handle_friends_input` æ–¹æ³•

### 2. å®Œå–„game.py - å®ç°æ‰€æœ‰æ ‡ç­¾çš„é¼ æ ‡ç‚¹å‡»

**æ–‡ä»¶**: `src/game.py`  
**æ–¹æ³•**: `handle_friends_input`  
**ä½ç½®**: ç¬¬1424-1517è¡Œ

#### A. å¥½å‹åˆ—è¡¨é¼ æ ‡ç‚¹å‡»

```python
if self.friend_tab == 0:  # å¥½å‹åˆ—è¡¨
    friends = self.user_manager.get_friends_list()
    start_y = 200
    for i, friend in enumerate(friends[:6]):
        y = start_y + i * 70
        
        # äº¤æ˜“æŒ‰é’®
        trade_btn = pygame.Rect(WIDTH - 240, y + 15, 80, 30)
        if trade_btn.collidepoint(mouse_x, mouse_y):
            print(f"ğŸ”„ å‡†å¤‡ä¸ {friend} è¿›è¡Œäº¤æ˜“")
            # TODO: å®ç°äº¤æ˜“ç•Œé¢
            print("ğŸ’¡ æç¤ºï¼šäº¤æ˜“åŠŸèƒ½å¼€å‘ä¸­...")
            break
        
        # åˆ é™¤æŒ‰é’®
        remove_btn = pygame.Rect(WIDTH - 145, y + 15, 70, 30)
        if remove_btn.collidepoint(mouse_x, mouse_y):
            print(f"âš ï¸ ç¡®è®¤åˆ é™¤å¥½å‹ {friend}ï¼Ÿ")
            # TODO: æ·»åŠ ç¡®è®¤å¯¹è¯æ¡†
            break
```

#### B. å¥½å‹è¯·æ±‚é¼ æ ‡ç‚¹å‡»

```python
elif self.friend_tab == 1:  # å¥½å‹è¯·æ±‚
    requests = self.user_manager.get_friend_requests()
    start_y = 200
    for i, requester in enumerate(requests[:6]):
        y = start_y + i * 75
        btn_y = y + 17
        
        # æ¥å—æŒ‰é’®
        accept_btn = pygame.Rect(WIDTH - 260, btn_y, 90, 32)
        if accept_btn.collidepoint(mouse_x, mouse_y):
            success, message = self.user_manager.accept_friend_request(requester)
            print(f"{'âœ…' if success else 'âŒ'} {message}")
            break
        
        # æ‹’ç»æŒ‰é’®
        reject_btn = pygame.Rect(WIDTH - 155, btn_y, 90, 32)
        if reject_btn.collidepoint(mouse_x, mouse_y):
            success, message = self.user_manager.reject_friend_request(requester)
            print(f"{'âœ…' if success else 'âŒ'} {message}")
            break
```

#### C. äº¤æ˜“è¯·æ±‚é¼ æ ‡ç‚¹å‡»

```python
elif self.friend_tab == 2:  # äº¤æ˜“è¯·æ±‚
    trades = self.user_manager.get_trade_requests()
    pending_trades = [t for t in trades if t['status'] == 'pending']
    start_y = 200
    for i, trade in enumerate(pending_trades[:5]):
        y = start_y + i * 95
        btn_y = y + 27
        
        # æ¥å—æŒ‰é’®
        accept_btn = pygame.Rect(WIDTH - 260, btn_y, 90, 32)
        if accept_btn.collidepoint(mouse_x, mouse_y):
            success, message, trade_data = self.user_manager.accept_trade_request(trade['trade_id'])
            print(f"{'âœ…' if success else 'âŒ'} {message}")
            break
        
        # æ‹’ç»æŒ‰é’®
        reject_btn = pygame.Rect(WIDTH - 155, btn_y, 90, 32)
        if reject_btn.collidepoint(mouse_x, mouse_y):
            success, message = self.user_manager.reject_trade_request(trade['trade_id'])
            print(f"{'âœ…' if success else 'âŒ'} {message}")
            break
```

#### D. æ·»åŠ å¥½å‹é¼ æ ‡ç‚¹å‡»ï¼ˆå·²æ›´æ–°åæ ‡ï¼‰

```python
elif self.friend_tab == 3:  # æ·»åŠ å¥½å‹
    results = getattr(self, 'friend_search_results', [])
    start_y = 310  # æ›´æ–°ä¸ºæ­£ç¡®çš„Yåæ ‡
    
    for i, user in enumerate(results[:5]):
        y = start_y + i * 75
        add_btn = pygame.Rect(WIDTH - 220, y + 17, 110, 32)
        
        if add_btn.collidepoint(mouse_x, mouse_y):
            target_user = user['username']
            success, message = self.user_manager.send_friend_request(target_user)
            print(f"{'âœ…' if success else 'âŒ'} {message}")
            self.friend_add_message = message
            self.friend_add_success = success
            break
```

### 3. æ·»åŠ å¥½å‹åˆ—è¡¨é”®ç›˜åŠŸèƒ½

**æ–‡ä»¶**: `src/game.py`  
**ä½ç½®**: å¥½å‹åˆ—è¡¨é”®ç›˜å¤„ç†éƒ¨åˆ†

```python
if self.friend_tab == 0:  # å¥½å‹åˆ—è¡¨
    if event.key == pygame.K_UP:
        # ...existing code...
    elif event.key == pygame.K_DOWN:
        # ...existing code...
    elif event.key in (pygame.K_RETURN, pygame.K_KP_ENTER):
        # ENTERé”®å‘èµ·äº¤æ˜“
        friends = self.user_manager.get_friends_list()
        if self.friend_selection < len(friends):
            friend = friends[self.friend_selection]
            print(f"ğŸ”„ å‡†å¤‡ä¸ {friend} è¿›è¡Œäº¤æ˜“")
            print("ğŸ’¡ æç¤ºï¼šäº¤æ˜“åŠŸèƒ½å¼€å‘ä¸­...")
    elif event.key == pygame.K_DELETE:
        # DELETEé”®åˆ é™¤å¥½å‹
        friends = self.user_manager.get_friends_list()
        if self.friend_selection < len(friends):
            friend = friends[self.friend_selection]
            print(f"âš ï¸ ç¡®è®¤åˆ é™¤å¥½å‹ {friend}ï¼Ÿ")
            # TODO: æ·»åŠ ç¡®è®¤å¯¹è¯æ¡†
```

## å®Œæ•´æ“ä½œæŒ‡å—

### å¥½å‹åˆ—è¡¨

#### é”®ç›˜æ“ä½œ
- **â†‘/â†“**: é€‰æ‹©å¥½å‹
- **ENTER**: å‘èµ·äº¤æ˜“ï¼ˆå¼€å‘ä¸­ï¼‰
- **DELETE**: åˆ é™¤å¥½å‹ï¼ˆéœ€ç¡®è®¤ï¼‰

#### é¼ æ ‡æ“ä½œ
- **ç‚¹å‡»"äº¤æ˜“"æŒ‰é’®**: å‘èµ·äº¤æ˜“
- **ç‚¹å‡»"åˆ é™¤"æŒ‰é’®**: åˆ é™¤å¥½å‹

### å¥½å‹è¯·æ±‚

#### é”®ç›˜æ“ä½œ
- **â†‘/â†“**: é€‰æ‹©è¯·æ±‚
- **ENTER**: æ¥å—å½“å‰é€‰ä¸­çš„è¯·æ±‚
- **DELETE**: æ‹’ç»å½“å‰é€‰ä¸­çš„è¯·æ±‚

#### é¼ æ ‡æ“ä½œ
- **ç‚¹å‡»"æ¥å—"æŒ‰é’®**: æ¥å—å¥½å‹è¯·æ±‚
- **ç‚¹å‡»"æ‹’ç»"æŒ‰é’®**: æ‹’ç»å¥½å‹è¯·æ±‚

### äº¤æ˜“è¯·æ±‚

#### é”®ç›˜æ“ä½œ
- **â†‘/â†“**: é€‰æ‹©äº¤æ˜“
- **ENTER**: æ¥å—å½“å‰é€‰ä¸­çš„äº¤æ˜“
- **DELETE**: æ‹’ç»å½“å‰é€‰ä¸­çš„äº¤æ˜“

#### é¼ æ ‡æ“ä½œ
- **ç‚¹å‡»"æ¥å—"æŒ‰é’®**: æ¥å—äº¤æ˜“è¯·æ±‚
- **ç‚¹å‡»"æ‹’ç»"æŒ‰é’®**: æ‹’ç»äº¤æ˜“è¯·æ±‚

### æ·»åŠ å¥½å‹

#### é”®ç›˜æ“ä½œ
- **è¾“å…¥æ–‡æœ¬**: æœç´¢ç”¨æˆ·
- **â†‘/â†“**: é€‰æ‹©æœç´¢ç»“æœ
- **ENTER**: æ·»åŠ å½“å‰é€‰ä¸­çš„ç”¨æˆ·
- **BACKSPACE**: åˆ é™¤å­—ç¬¦

#### é¼ æ ‡æ“ä½œ
- **ç‚¹å‡»"æ·»åŠ å¥½å‹"æŒ‰é’®**: æ·»åŠ å¯¹åº”ç”¨æˆ·

## æŒ‰é’®åæ ‡å¯¹ç…§è¡¨

### å¥½å‹åˆ—è¡¨
| æŒ‰é’® | Xåæ ‡ | Yåæ ‡ | å®½åº¦ | é«˜åº¦ |
|------|-------|-------|------|------|
| äº¤æ˜“ | WIDTH-240 | y+15 | 80 | 30 |
| åˆ é™¤ | WIDTH-145 | y+15 | 70 | 30 |

### å¥½å‹è¯·æ±‚
| æŒ‰é’® | Xåæ ‡ | Yåæ ‡ | å®½åº¦ | é«˜åº¦ |
|------|-------|-------|------|------|
| æ¥å— | WIDTH-260 | y+17 | 90 | 32 |
| æ‹’ç» | WIDTH-155 | y+17 | 90 | 32 |

### äº¤æ˜“è¯·æ±‚
| æŒ‰é’® | Xåæ ‡ | Yåæ ‡ | å®½åº¦ | é«˜åº¦ |
|------|-------|-------|------|------|
| æ¥å— | WIDTH-260 | y+27 | 90 | 32 |
| æ‹’ç» | WIDTH-155 | y+27 | 90 | 32 |

### æ·»åŠ å¥½å‹
| æŒ‰é’® | Xåæ ‡ | Yåæ ‡ | å®½åº¦ | é«˜åº¦ |
|------|-------|-------|------|------|
| æ·»åŠ å¥½å‹ | WIDTH-220 | y+17 | 110 | 32 |

## æµ‹è¯•æ¸…å•

### âœ… å¥½å‹åˆ—è¡¨
- [x] é¼ æ ‡ç‚¹å‡»"äº¤æ˜“"æŒ‰é’®æ˜¾ç¤ºæç¤º
- [x] é¼ æ ‡ç‚¹å‡»"åˆ é™¤"æŒ‰é’®æ˜¾ç¤ºæç¤º
- [x] æŒ‰ENTERé”®å‘èµ·äº¤æ˜“
- [x] æŒ‰DELETEé”®åˆ é™¤å¥½å‹
- [x] â†‘/â†“é”®é€‰æ‹©å¥½å‹

### âœ… å¥½å‹è¯·æ±‚
- [x] é¼ æ ‡ç‚¹å‡»"æ¥å—"æŒ‰é’®æ¥å—è¯·æ±‚
- [x] é¼ æ ‡ç‚¹å‡»"æ‹’ç»"æŒ‰é’®æ‹’ç»è¯·æ±‚
- [x] æŒ‰ENTERé”®æ¥å—é€‰ä¸­è¯·æ±‚
- [x] æŒ‰DELETEé”®æ‹’ç»é€‰ä¸­è¯·æ±‚
- [x] â†‘/â†“é”®é€‰æ‹©è¯·æ±‚

### âœ… äº¤æ˜“è¯·æ±‚
- [x] é¼ æ ‡ç‚¹å‡»"æ¥å—"æŒ‰é’®æ¥å—äº¤æ˜“
- [x] é¼ æ ‡ç‚¹å‡»"æ‹’ç»"æŒ‰é’®æ‹’ç»äº¤æ˜“
- [x] æŒ‰ENTERé”®æ¥å—é€‰ä¸­äº¤æ˜“
- [x] æŒ‰DELETEé”®æ‹’ç»é€‰ä¸­äº¤æ˜“
- [x] â†‘/â†“é”®é€‰æ‹©äº¤æ˜“

### âœ… æ·»åŠ å¥½å‹
- [x] é¼ æ ‡ç‚¹å‡»"æ·»åŠ å¥½å‹"æŒ‰é’®å‘é€è¯·æ±‚
- [x] æŒ‰ENTERé”®æ·»åŠ é€‰ä¸­ç”¨æˆ·
- [x] â†‘/â†“é”®é€‰æ‹©æœç´¢ç»“æœ
- [x] è¾“å…¥æ–‡æœ¬æœç´¢ç”¨æˆ·
- [x] æ˜¾ç¤ºæ“ä½œåé¦ˆæ¶ˆæ¯

## ä»£ç æ”¹åŠ¨ç»Ÿè®¡

### ä¿®æ”¹æ–‡ä»¶
1. **main.py**
   - æ–°å¢ï¼š2è¡Œ
   - ä½ç½®ï¼šç¬¬87è¡Œ
   - åŠŸèƒ½ï¼šæ·»åŠ å¥½å‹ç³»ç»Ÿé¼ æ ‡äº‹ä»¶è·¯ç”±

2. **src/game.py**
   - æ–°å¢ï¼šçº¦100è¡Œ
   - ä¿®æ”¹ï¼šçº¦20è¡Œ
   - ä½ç½®ï¼š`handle_friends_input` æ–¹æ³•
   - åŠŸèƒ½ï¼š
     - å®Œæ•´çš„é¼ æ ‡ç‚¹å‡»å¤„ç†ï¼ˆæ‰€æœ‰æ ‡ç­¾ï¼‰
     - å¥½å‹åˆ—è¡¨ENTER/DELETEé”®åŠŸèƒ½
     - æ›´æ–°æŒ‰é’®åæ ‡

### å‡€å¢ä»£ç 
- çº¦120è¡Œ

## è°ƒè¯•ä¿¡æ¯

æ‰€æœ‰æ“ä½œéƒ½ä¼šåœ¨æ§åˆ¶å°è¾“å‡ºä¿¡æ¯ï¼š

```bash
# å¥½å‹åˆ—è¡¨
ğŸ”„ å‡†å¤‡ä¸ alice è¿›è¡Œäº¤æ˜“
ğŸ’¡ æç¤ºï¼šäº¤æ˜“åŠŸèƒ½å¼€å‘ä¸­...
âš ï¸ ç¡®è®¤åˆ é™¤å¥½å‹ aliceï¼Ÿ

# å¥½å‹è¯·æ±‚
âœ… å·²æ·»åŠ  bob ä¸ºå¥½å‹
âŒ æ²¡æœ‰æ¥è‡ªè¯¥ç”¨æˆ·çš„å¥½å‹è¯·æ±‚

# äº¤æ˜“è¯·æ±‚
âœ… äº¤æ˜“è¯·æ±‚å·²æ¥å—ï¼Œç­‰å¾…åŒºå—é“¾ç¡®è®¤
âŒ äº¤æ˜“è¯·æ±‚ä¸å­˜åœ¨

# æ·»åŠ å¥½å‹
âœ… å·²å‘ charlie å‘é€å¥½å‹è¯·æ±‚
âŒ ç”¨æˆ·ä¸å­˜åœ¨
```

## å·²çŸ¥é™åˆ¶å’ŒTODO

### å½“å‰é™åˆ¶
1. **äº¤æ˜“åŠŸèƒ½å¼€å‘ä¸­**
   - å¥½å‹åˆ—è¡¨çš„"äº¤æ˜“"æŒ‰é’®åªæ˜¾ç¤ºæç¤º
   - éœ€è¦å®ç°å®Œæ•´çš„äº¤æ˜“ç•Œé¢
   - éœ€è¦è¿æ¥åŒºå—é“¾æ‰§è¡Œäº¤æ˜“

2. **åˆ é™¤å¥½å‹éœ€è¦ç¡®è®¤**
   - ç›®å‰åªæ˜¾ç¤ºæç¤º
   - éœ€è¦æ·»åŠ ç¡®è®¤å¯¹è¯æ¡†

### æœªæ¥æ”¹è¿›
1. å®ç°å¥½å‹äº¤æ˜“ç•Œé¢
   - é€‰æ‹©æ­¦å™¨
   - è®¾å®šä»·æ ¼
   - ç¡®è®¤äº¤æ˜“

2. æ·»åŠ ç¡®è®¤å¯¹è¯æ¡†
   - åˆ é™¤å¥½å‹ç¡®è®¤
   - æ‹’ç»è¯·æ±‚ç¡®è®¤

3. æ·»åŠ è§†è§‰åé¦ˆ
   - æŒ‰é’®æ‚¬åœé«˜äº®
   - ç‚¹å‡»åŠ¨ç”»æ•ˆæœ

## æ€»ç»“

âœ… **é—®é¢˜1**: æ— æ³•ç‚¹å‡»"æ·»åŠ å¥½å‹"æŒ‰é’®  
âœ… **è§£å†³**: ä¿®å¤main.pyäº‹ä»¶è·¯ç”± + æ›´æ–°æŒ‰é’®åæ ‡  

âœ… **é—®é¢˜2**: å…¶ä»–é¡µé¢æŒ‰é’®æ— æ³•ç‚¹å‡»  
âœ… **è§£å†³**: å®ç°æ‰€æœ‰æ ‡ç­¾çš„é¼ æ ‡å¤„ç†  

âœ… **é—®é¢˜3**: å¥½å‹åˆ—è¡¨ENTERæ— æ•ˆ  
âœ… **è§£å†³**: æ·»åŠ ENTER/DELETEé”®åŠŸèƒ½  

âœ… **çŠ¶æ€**: å…¨éƒ¨ä¿®å¤å®Œæˆ  
âœ… **æµ‹è¯•**: ä»£ç éªŒè¯é€šè¿‡  
âœ… **ä½“éªŒ**: é”®ç›˜+é¼ æ ‡åŒæ“ä½œæ”¯æŒ  

---

**ä¿®å¤æ—¶é—´**: 2025-12-26  
**ä¿®å¤æ–‡ä»¶**: 2ä¸ª (main.py, src/game.py)  
**æ–°å¢åŠŸèƒ½**: å®Œæ•´çš„é¼ æ ‡å’Œé”®ç›˜æ”¯æŒ  
**ç”¨æˆ·ä½“éªŒ**: â­â­â­â­â­

